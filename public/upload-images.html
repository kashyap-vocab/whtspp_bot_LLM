<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">

    <title>Upload Images - AutoSherpa</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .sidebar {
            min-height: 100vh;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
        }
        .sidebar .nav-link {
            color: rgba(255, 255, 255, 0.8);
            padding: 12px 20px;
            border-radius: 8px;
            margin: 5px 0;
            transition: all 0.3s ease;
        }
        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            color: white;
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }
        .sidebar .nav-link i {
            width: 20px;
            margin-right: 10px;
        }
        .main-content {
            background: #f8f9fa;
            min-height: 100vh;
        }
        .upload-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }
        .image-upload-area {
            border: 2px dashed #dee2e6;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .image-upload-area:hover {
            border-color: #667eea;
            background-color: #f8f9ff;
        }
        .image-upload-area.has-image {
            border-color: #28a745;
            background-color: #f8fff9;
        }
        .image-preview {
            max-width: 100%;
            max-height: 100px;
            border-radius: 8px;
            margin-top: 10px;
        }
        .navbar-brand {
            font-weight: 700;
            color: #2c3e50 !important;
        }
        .car-search {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
        }
        .image-type-label {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }
        .upload-progress {
            height: 25px;
            border-radius: 15px;
        }
        
        .form-label {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .form-select, .form-control {
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.9);
        }
        
        .form-select:focus, .form-control:focus {
            border-color: #fff;
            box-shadow: 0 0 0 0.2rem rgba(255, 255, 255, 0.25);
        }
        
        .car-search .row {
            align-items: end;
        }
        
        /* Live Image Capture Styles */
        .camera-container {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .camera-overlay {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .capture-preview {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            border: 2px dashed #dee2e6;
        }
        
        .capture-preview.has-image {
            border-color: #28a745;
            background-color: #f8fff9;
        }
        
        .btn-group .btn {
            border-radius: 6px;
            margin: 0 2px;
        }
        
        .btn-group .btn:first-child {
            border-top-left-radius: 6px;
            border-bottom-left-radius: 6px;
        }
        
        .btn-group .btn:last-child {
            border-top-right-radius: 6px;
            border-bottom-right-radius: 6px;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .camera-container video,
            .camera-container canvas {
                width: 100% !important;
                height: 200px !important;
            }
            
            .btn-group {
                flex-direction: column;
                width: 100%;
            }
            
            .btn-group .btn {
                margin: 2px 0;
                border-radius: 6px !important;
            }
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 px-0 sidebar">
                <div class="p-3">
                    <h4 class="text-center mb-4">
                        <i class="fas fa-car me-2"></i>AutoSherpa
                    </h4>
                    
                    <nav class="nav flex-column">
                        <a class="nav-link" href="/dashboard">
                            <i class="fas fa-tachometer-alt"></i>Dashboard
                        </a>
                        <a class="nav-link" href="/upload-cars">
                            <i class="fas fa-upload"></i>Upload Cars
                        </a>
                        <a class="nav-link active" href="/upload-images">
                            <i class="fas fa-images"></i>Upload Images
                        </a>
                        <a class="nav-link" href="/view-cars">
                            <i class="fas fa-car-side"></i>View Cars
                        </a>
                        <a class="nav-link" href="/test-drive-bookings">
                            <i class="fas fa-calendar-check"></i>Test Drive Bookings
                        </a>
                        <a class="nav-link" href="/car-valuations">
                            <i class="fas fa-calculator"></i>Car Valuations
                        </a>
                    </nav>
                    
                    <hr class="my-4">
                    
                    <div class="text-center">
                        <button class="btn btn-outline-light btn-sm" onclick="logout()">
                            <i class="fas fa-sign-out-alt me-2"></i>Logout
                        </button>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-md-9 col-lg-10 main-content">
                <!-- Top Navigation -->
                <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
                    <div class="container-fluid">
                        <span class="navbar-brand">Upload Images</span>
                        <div class="navbar-nav ms-auto">
                            <span class="navbar-text me-3">
                                Welcome, <span id="userName">Dealer</span>
                            </span>
                        </div>
                    </div>
                </nav>

                <div class="p-4">
                    <!-- Car Search Section -->
                    <div class="car-search">
                        <h5 class="mb-3">
                            <i class="fas fa-search me-2"></i>Find Car for Image Upload
                        </h5>
                        
                        <!-- Search Options -->
                        <div class="row g-3 mb-3">
                            <div class="col-md-3">
                                <label for="brandFilter" class="form-label text-white">Brand</label>
                                <select class="form-select" id="brandFilter" onchange="filterCars()">
                                    <option value="">All Brands</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="modelFilter" class="form-label text-white">Model</label>
                                <select class="form-select" id="modelFilter" onchange="onModelChange()">
                                    <option value="">All Models</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="registrationFilter" class="form-label text-white">Registration Number</label>
                                <select class="form-select" id="registrationFilter" onchange="selectCarByRegistration()">
                                    <option value="">Select Registration</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="searchInput" class="form-label text-white">Search</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="searchInput" 
                                           placeholder="Search cars..." 
                                           onkeyup="searchCars()">
                                    <button class="btn btn-light" type="button" onclick="searchCars()">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-outline-light btn-sm mt-4" onclick="clearFilters()">
                                    <i class="fas fa-times me-1"></i>Clear Filters
                                </button>
                            </div>
                        </div>
                        
                        <!-- Quick Registration Number Input -->
                        <div class="row">
                            <div class="col-md-6">
                                <label for="registrationNumber" class="form-label text-white">Quick Registration Number</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="registrationNumber" 
                                           placeholder="Enter registration number (e.g., MH12AB1234)" 
                                           onkeyup="searchCarByRegistration()">
                                    <button class="btn btn-light" type="button" onclick="searchCarByRegistration()">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Filter Status Display -->
                        <div id="filterStatus" class="mt-3" style="display: none;">
                            <div class="alert alert-light">
                                <h6 class="mb-2">
                                    <i class="fas fa-filter me-2"></i>Current Filters
                                </h6>
                                <div class="row">
                                    <div class="col-md-3">
                                        <strong>Brand:</strong> <span id="currentBrand">All</span>
                                    </div>
                                    <div class="col-md-3">
                                        <strong>Model:</strong> <span id="currentModel">All</span>
                                    </div>
                                    <div class="col-md-3">
                                        <strong>Cars Found:</strong> <span id="carsCount">0</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Car Info Display -->
                        <div id="carInfo" style="display: none;" class="mt-3">
                            <div class="alert alert-info">
                                <h6 class="mb-2">
                                    <i class="fas fa-car me-2"></i>
                                    <span id="carDetails"></span>
                                </h6>
                                <small>Now you can upload 4 images for this car</small>
                            </div>
                        </div>
                        
                        <!-- Pre-selected Car Info Display -->
                        <div id="selectedCarInfo" class="mt-3" style="display: none;">
                            <!-- Pre-selected car info will be displayed here -->
                        </div>
                    </div>

                    <!-- Image Upload Section -->
                    <div class="upload-card">
                        <h4 class="mb-4">
                            <i class="fas fa-images me-2"></i>Upload Car Images
                        </h4>
                        
                        <div id="uploadSection" style="display: none;">
                            <div class="row g-4">
                                <div class="col-md-6">
                                    <div class="image-upload-area" id="frontImageArea" onclick="selectImage('front')">
                                        <i class="fas fa-car fa-2x text-primary mb-2"></i>
                                        <h6>Front View</h6>
                                        <small class="text-muted">Click to upload</small>
                                        <div id="frontImagePreview"></div>
                                        <input type="file" id="frontImage" accept="image/*" style="display: none;" 
                                               onchange="previewImage('front', this)">
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="image-upload-area" id="backImageArea" onclick="selectImage('back')">
                                        <i class="fas fa-car fa-2x text-primary mb-2"></i>
                                        <h6>Back View</h6>
                                        <small class="text-muted">Click to upload</small>
                                        <div id="backImagePreview"></div>
                                        <input type="file" id="backImage" accept="image/*" style="display: none;" 
                                               onchange="previewImage('back', this)">
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="image-upload-area" id="sideImageArea" onclick="selectImage('side')">
                                        <i class="fas fa-car fa-2x text-primary mb-2"></i>
                                        <h6>Side View</h6>
                                        <small class="text-muted">Click to upload</small>
                                        <div id="sideImagePreview"></div>
                                        <input type="file" id="sideImage" accept="image/*" style="display: none;" 
                                               onchange="previewImage('side', this)">
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="image-upload-area" id="interiorImageArea" onclick="selectImage('interior')">
                                        <i class="fas fa-car fa-2x text-primary mb-2"></i>
                                        <h6>Interior</h6>
                                        <small class="text-muted">Click to upload</small>
                                        <div id="interiorImagePreview"></div>
                                        <input type="file" id="interiorImage" accept="image/*" style="display: none;" 
                                               onchange="previewImage('interior', this)">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Live Image Capture Section -->
                            <div class="row mt-4">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">
                                                <i class="fas fa-camera me-2"></i>Live Image Capture
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="text-center">
                                                        <div class="camera-container">
                                                            <video id="camera" width="100%" height="300" autoplay style="border-radius: 8px; background: #000;"></video>
                                                            <div class="camera-overlay" id="cameraStatus" style="display: none;">
                                                                <i class="fas fa-camera me-1"></i>Camera Active
                                                            </div>
                                                        </div>
                                                        <div class="mt-3">
                                                            <div class="mb-2">
                                                                <label for="captureImageType" class="form-label">Select Image Type:</label>
                                                                <select class="form-select form-select-sm" id="captureImageType" style="max-width: 200px; margin: 0 auto;">
                                                                    <option value="">Choose type...</option>
                                                                    <option value="front">Front View</option>
                                                                    <option value="back">Back View</option>
                                                                    <option value="side">Side View</option>
                                                                    <option value="interior">Interior</option>
                                                                </select>
                                                            </div>
                                                            <div class="btn-group" role="group">
                                                                <button class="btn btn-success btn-sm" onclick="startCamera()" id="startCameraBtn">
                                                                    <i class="fas fa-play me-1"></i>Start Camera
                                                                </button>
                                                                <button class="btn btn-danger btn-sm" onclick="stopCamera()" id="stopCameraBtn" disabled>
                                                                    <i class="fas fa-stop me-1"></i>Stop Camera
                                                                </button>
                                                                <button class="btn btn-primary btn-sm" onclick="captureImage()" id="captureBtn" disabled>
                                                                    <i class="fas fa-camera me-1"></i>Capture
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="text-center">
                                                        <div class="capture-preview" id="capturePreview">
                                                            <canvas id="canvas" width="400" height="300" style="border: 1px solid #ddd; border-radius: 8px; display: none;"></canvas>
                                                            <div id="capturedImagePreview" class="mt-2"></div>
                                                            <div class="mt-2" id="captureButtons" style="display: none;">
                                                                <button class="btn btn-success btn-sm me-2" onclick="useCapturedImage()">
                                                                    <i class="fas fa-check me-1"></i>Use This Image
                                                                </button>
                                                                <button class="btn btn-secondary btn-sm" onclick="discardCapturedImage()">
                                                                    <i class="fas fa-times me-1"></i>Discard
                                                                </button>
                                                            </div>
                                                            <div class="mt-3" id="captureInstructions">
                                                                <small class="text-muted">
                                                                    <i class="fas fa-info-circle me-1"></i>
                                                                    Select an image type above, then start camera and capture
                                                                </small>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Upload Progress -->
                            <div id="uploadProgress" style="display: none;" class="mt-4">
                                <h6>Uploading images...</h6>
                                <div class="progress mb-3">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                         role="progressbar" style="width: 0%" id="progressBar">0%</div>
                                </div>
                            </div>
                            
                            <!-- Upload Button -->
                            <div class="text-center mt-4">
                                <button class="btn btn-primary btn-lg" onclick="uploadImages()" id="uploadBtn" disabled>
                                    <i class="fas fa-upload me-2"></i>Upload All Images
                                </button>
                            </div>
                        </div>
                        
                        <!-- Instructions -->
                        <div id="instructions" class="mt-4">
                            <div class="alert alert-info">
                                <h6><i class="fas fa-info-circle me-2"></i>Instructions</h6>
                                <ul class="mb-0">
                                    <li>First, search for a car using its registration number</li>
                                    <li>Upload 4 images: Front, Back, Side, and Interior views</li>
                                    <li>Images will be organized by registration number</li>
                                    <li>Supported formats: JPG, PNG, GIF</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentCarId = null;
        let currentRegistrationNumber = '';
        let uploadedImages = {
            front: null,
            back: null,
            side: null,
            interior: null
        };
        let allCars = []; // Store all cars for filtering
        
        // Camera variables
        let stream = null;
        let capturedImage = null;
        let selectedImageType = null;

        // Check authentication
        async function checkAuth() {
            const token = localStorage.getItem('authToken');
            if (!token) {
                window.location.href = '/login';
                return;
            }
            
            try {
                const response = await fetch('/api/cars', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const userData = JSON.parse(localStorage.getItem('userData') || '{}');
                    document.getElementById('userName').textContent = userData.username || 'Dealer';
                    loadCars(); // Load cars for dropdowns
                } else {
                    window.location.href = '/login';
                }
            } catch (error) {
                console.error('Auth check error:', error);
                window.location.href = '/login';
            }
        }



        // Display car information
        function displayCarInfo(car) {
            document.getElementById('carDetails').textContent = 
                `${car.brand} ${car.model} ${car.variant} (${car.year})`;
            document.getElementById('carInfo').style.display = 'block';
        }

        // Hide car information
        function hideCarInfo() {
            document.getElementById('carInfo').style.display = 'none';
            document.getElementById('uploadSection').style.display = 'none';
            currentCarId = null;
            currentRegistrationNumber = '';
            resetUploads();
            resetCameraInterface();
        }

        // Show upload section
        function showUploadSection() {
            document.getElementById('uploadSection').style.display = 'block';
            document.getElementById('instructions').style.display = 'none';
        }

        // Select image
        function selectImage(type) {
            selectedImageType = type; // Set the selected type for live capture
            document.getElementById(`${type}Image`).click();
        }

        // Preview image
        function previewImage(type, input) {
            const file = input.files[0];
            if (file) {
                uploadedImages[type] = file;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const previewDiv = document.getElementById(`${type}ImagePreview`);
                    previewDiv.innerHTML = `
                        <img src="${e.target.result}" class="image-preview" alt="${type} view">
                        <div class="image-type-label">${type.toUpperCase()} VIEW</div>
                    `;
                    
                    document.getElementById(`${type}ImageArea`).classList.add('has-image');
                };
                reader.readAsDataURL(file);
                
                checkUploadReady();
            }
        }

        // Check if ready to upload
        function checkUploadReady() {
            const allImagesUploaded = Object.values(uploadedImages).every(img => img !== null);
            document.getElementById('uploadBtn').disabled = !allImagesUploaded;
        }

        // Upload images
        async function uploadImages() {
            if (!currentCarId) {
                alert('Please select a car first');
                return;
            }
            
            const allImagesUploaded = Object.values(uploadedImages).every(img => img !== null);
            if (!allImagesUploaded) {
                alert('Please upload all 4 images');
                return;
            }
            
            // Show progress
            document.getElementById('uploadProgress').style.display = 'block';
            document.getElementById('uploadBtn').disabled = true;
            
            try {
                const token = localStorage.getItem('authToken');
                const formData = new FormData();
                
                // Define image types and their corresponding indices
                const imageTypes = ['front', 'back', 'side', 'interior'];
                const imageIndices = [];
                
                // Add images to form data with proper indexing
                imageTypes.forEach((type, index) => {
                    const imageData = uploadedImages[type];
                    if (imageData) {
                        if (imageData instanceof File) {
                            // Handle file uploads
                            formData.append('images', imageData);
                        } else if (typeof imageData === 'string' && imageData.startsWith('data:image/')) {
                            // Handle captured images (convert base64 to blob)
                            const base64Data = imageData.split(',')[1];
                            const byteCharacters = atob(base64Data);
                            const byteNumbers = new Array(byteCharacters.length);
                            for (let i = 0; i < byteCharacters.length; i++) {
                                byteNumbers[i] = byteCharacters.charCodeAt(i);
                            }
                            const byteArray = new Uint8Array(byteNumbers);
                            const blob = new Blob([byteArray], { type: 'image/jpeg' });
                            const file = new File([blob], `${type}_captured.jpg`, { type: 'image/jpeg' });
                            formData.append('images', file);
                        }
                        imageIndices.push(index); // Build the indices array
                    }
                });
                
                // Add metadata
                formData.append('registrationNumber', currentRegistrationNumber);
                formData.append('imageTypes', JSON.stringify(imageTypes));
                formData.append('imageIndices', JSON.stringify(imageIndices)); // Send as JSON string
                
                console.log(`üì∏ Uploading ${imageTypes.length} images for car ${currentRegistrationNumber}`);
                console.log(`üì∏ Image indices:`, imageIndices);
                console.log(`üì∏ Image types:`, imageTypes);
                
                const response = await fetch('/api/upload-car-images', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert('Images uploaded successfully!');
                    console.log('‚úÖ Upload result:', result);
                    resetUploads();
                    hideCarInfo();
                    document.getElementById('registrationNumber').value = '';
                    // Stop camera if it's running
                    stopCamera();
                } else {
                    alert('Upload failed: ' + (result.error || 'Unknown error'));
                }
                
            } catch (error) {
                console.error('Upload error:', error);
                alert('An error occurred during upload');
            } finally {
                // Hide progress
                document.getElementById('uploadProgress').style.display = 'none';
                document.getElementById('uploadBtn').disabled = false;
            }
        }

        // Reset uploads
        function resetUploads() {
            uploadedImages = {
                front: null,
                back: null,
                side: null,
                interior: null
            };
            
            // Reset previews
            ['front', 'back', 'side', 'interior'].forEach(type => {
                document.getElementById(`${type}ImagePreview`).innerHTML = '';
                document.getElementById(`${type}ImageArea`).classList.remove('has-image');
                document.getElementById(`${type}Image`).value = '';
            });
            
            // Reset camera interface
            stopCamera();
            document.getElementById('captureImageType').value = '';
            document.getElementById('capturedImagePreview').innerHTML = '';
            document.getElementById('captureButtons').style.display = 'none';
            document.getElementById('captureInstructions').style.display = 'block';
            
            document.getElementById('uploadBtn').disabled = true;
        }

        // Reset camera interface specifically
        function resetCameraInterface() {
            stopCamera();
            document.getElementById('captureImageType').value = '';
            document.getElementById('capturedImagePreview').innerHTML = '';
            document.getElementById('captureButtons').style.display = 'none';
            document.getElementById('captureInstructions').style.display = 'block';
            document.getElementById('canvas').style.display = 'none';
        }

        // Load cars for dropdowns
        async function loadCars() {
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch('/api/cars', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    allCars = await response.json();
                    console.log('üöó Loaded cars from database:', allCars.length);
                    console.log('üìä Available brands:', [...new Set(allCars.map(car => car.brand))].sort());
                    populateDropdowns(allCars);
                    
                    // Check if a specific car was requested via URL parameter
                    const urlParams = new URLSearchParams(window.location.search);
                    const requestedCar = urlParams.get('car');
                    if (requestedCar) {
                        preSelectCar(requestedCar);
                    }
                }
            } catch (error) {
                console.error('Load cars error:', error);
            }
        }

        // Pre-select a specific car based on ID or registration number
        function preSelectCar(carIdentifier) {
            console.log('üéØ Pre-selecting car:', carIdentifier);
            
            // Try to find car by ID first, then by registration number
            let car = allCars.find(c => c.id == carIdentifier || c.registration_number === carIdentifier);
            
            if (car) {
                console.log('‚úÖ Found car for pre-selection:', car);
                
                // Set brand filter
                document.getElementById('brandFilter').value = car.brand;
                
                // Trigger brand change to populate models
                filterCars();
                
                // Set model filter after a short delay to ensure models are populated
                setTimeout(() => {
                    document.getElementById('modelFilter').value = car.model;
                    document.getElementById('registrationFilter').value = car.registration_number;
                    
                    // Update the display
                    updateSelectedCarDisplay(car);
                }, 100);
            } else {
                console.log('‚ùå Car not found for pre-selection:', carIdentifier);
            }
        }

        // Update the display when a car is selected
        function updateSelectedCarDisplay(car) {
            const selectedCarInfo = document.getElementById('selectedCarInfo');
            if (selectedCarInfo && car) {
                selectedCarInfo.innerHTML = `
                    <div class="alert alert-info">
                        <strong>Selected Car:</strong> ${car.brand} ${car.model} (${car.registration_number})
                        ${car.type ? `<br><small>Type: ${car.type}</small>` : ''}
                    </div>
                `;
                selectedCarInfo.style.display = 'block';
            }
        }

        // Populate dropdowns with car data
        function populateDropdowns(cars) {
            const brandFilter = document.getElementById('brandFilter');
            const modelFilter = document.getElementById('modelFilter');
            const registrationFilter = document.getElementById('registrationFilter');
            
            // Clear existing options
            brandFilter.innerHTML = '<option value="">All Brands</option>';
            modelFilter.innerHTML = '<option value="">All Models</option>';
            registrationFilter.innerHTML = '<option value="">Select Registration</option>';
            
            // Get unique brands and models
            const brands = [...new Set(cars.map(car => car.brand))].sort();
            
            // Populate brand dropdown
            brands.forEach(brand => {
                const option = document.createElement('option');
                option.value = brand;
                option.textContent = brand;
                brandFilter.appendChild(option);
            });
            
            // Don't populate model dropdown initially - it will be populated when brand is selected
            // Populate registration dropdown
            cars.forEach(car => {
                const option = document.createElement('option');
                option.value = car.registration_number;
                option.textContent = `${car.registration_number} - ${car.brand} ${car.model}`;
                registrationFilter.appendChild(option);
            });
        }

        // Filter cars based on brand and model selection (called when brand changes)
        function filterCars() {
            const selectedBrand = document.getElementById('brandFilter').value;
            
            console.log(`üîÑ Brand changed to: ${selectedBrand}`);
            
            // Update model dropdown based on selected brand
            const modelFilter = document.getElementById('modelFilter');
            modelFilter.innerHTML = '<option value="">All Models</option>';
            
            if (selectedBrand) {
                // Get models available for the selected brand
                const brandModels = [...new Set(allCars
                    .filter(car => car.brand === selectedBrand)
                    .map(car => car.model)
                )].sort();
                
                console.log(`üìä Available models for ${selectedBrand}:`, brandModels);
                
                // Populate model dropdown with only available models for this brand
                brandModels.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model;
                    option.textContent = model;
                    modelFilter.appendChild(option);
                });
                
                // Reset model selection when brand changes
                modelFilter.value = '';
            }
            
            // Update registration dropdown with cars from selected brand only
            let filteredCars = allCars;
            if (selectedBrand) {
                filteredCars = filteredCars.filter(car => car.brand === selectedBrand);
                console.log(`üîç Filtered by brand ${selectedBrand}:`, filteredCars.length, 'cars');
            }
            
            // Update registration dropdown with filtered cars
            const registrationFilter = document.getElementById('registrationFilter');
            registrationFilter.innerHTML = '<option value="">Select Registration</option>';
            
            filteredCars.forEach(car => {
                const option = document.createElement('option');
                option.value = car.registration_number;
                option.textContent = `${car.registration_number} - ${car.brand} ${car.model}`;
                registrationFilter.appendChild(option);
            });
            
            console.log(`üìã Cars after brand filter:`, filteredCars.length);
            
            // Update filter status
            updateFilterStatus();
        }

        // Select car by registration number from dropdown
        function selectCarByRegistration() {
            const selectedRegistration = document.getElementById('registrationFilter').value;
            if (selectedRegistration) {
                const car = allCars.find(c => c.registration_number === selectedRegistration);
                if (car) {
                    displayCarInfo(car);
                    currentCarId = car.id;
                    currentRegistrationNumber = car.registration_number;
                    showUploadSection();
                }
            }
        }

        // Search cars by text input
        function searchCars() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            if (!searchTerm) {
                populateDropdowns(allCars);
                return;
            }
            
            const filteredCars = allCars.filter(car => 
                car.brand.toLowerCase().includes(searchTerm) ||
                car.model.toLowerCase().includes(searchTerm) ||
                car.variant.toLowerCase().includes(searchTerm) ||
                car.registration_number.toLowerCase().includes(searchTerm)
            );
            
            populateDropdowns(filteredCars);
        }

        // Update filter status display
        function updateFilterStatus() {
            const selectedBrand = document.getElementById('brandFilter').value;
            const selectedModel = document.getElementById('modelFilter').value;
            
            // Count filtered cars
            let filteredCars = allCars;
            if (selectedBrand) {
                filteredCars = filteredCars.filter(car => car.brand === selectedBrand);
            }
            if (selectedModel) {
                filteredCars = filteredCars.filter(car => car.model === selectedModel);
            }
            
            // Update display
            document.getElementById('currentBrand').textContent = selectedBrand || 'All';
            document.getElementById('currentModel').textContent = selectedModel || 'All';
            document.getElementById('carsCount').textContent = filteredCars.length;
            
            // Show/hide filter status
            if (selectedBrand || selectedModel) {
                document.getElementById('filterStatus').style.display = 'block';
            } else {
                document.getElementById('filterStatus').style.display = 'none';
            }
        }

        // Handle model dropdown change
        function onModelChange() {
            const selectedBrand = document.getElementById('brandFilter').value;
            const selectedModel = document.getElementById('modelFilter').value;
            
            console.log(`üîÑ Model changed to: ${selectedModel}`);
            
            let filteredCars = allCars;
            
            if (selectedBrand) {
                filteredCars = filteredCars.filter(car => car.brand === selectedBrand);
            }
            
            if (selectedModel) {
                filteredCars = filteredCars.filter(car => car.model === selectedModel);
            }
            
            // Update registration dropdown with filtered cars
            const registrationFilter = document.getElementById('registrationFilter');
            registrationFilter.innerHTML = '<option value="">Select Registration</option>';
            
            filteredCars.forEach(car => {
                const option = document.createElement('option');
                option.value = car.registration_number;
                option.textContent = `${car.registration_number} - ${car.brand} ${car.model}`;
                registrationFilter.appendChild(option);
            });
            
            console.log(`üìã Cars after model filter:`, filteredCars.length);
            
            // Update filter status
            updateFilterStatus();
        }

        // Clear all filters and reset dropdowns
        function clearFilters() {
            document.getElementById('brandFilter').value = '';
            document.getElementById('modelFilter').value = '';
            document.getElementById('searchInput').value = '';
            
            // Reset model dropdown to show no options
            document.getElementById('modelFilter').innerHTML = '<option value="">All Models</option>';
            
            // Reset registration dropdown to show all cars
            const registrationFilter = document.getElementById('registrationFilter');
            registrationFilter.innerHTML = '<option value="">Select Registration</option>';
            
            allCars.forEach(car => {
                const option = document.createElement('option');
                option.value = car.registration_number;
                option.textContent = `${car.registration_number} - ${car.brand} ${car.model}`;
                registrationFilter.appendChild(option);
            });
            
            console.log('üßπ Filters cleared, showing all cars:', allCars.length);
        }

        // Search car by registration number (quick search)
        async function searchCarByRegistration() {
            const registrationNumber = document.getElementById('registrationNumber').value.trim();
            
            if (!registrationNumber) {
                alert('Please enter a registration number');
                return;
            }
            
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`/api/cars?registration=${registrationNumber}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const cars = await response.json();
                    const car = cars.find(c => c.registration_number === registrationNumber);
                    
                    if (car) {
                        displayCarInfo(car);
                        currentCarId = car.id;
                        currentRegistrationNumber = car.registration_number;
                        showUploadSection();
                    } else {
                        alert('Car not found with this registration number');
                        hideCarInfo();
                    }
                } else {
                    alert('Error searching for car');
                }
            } catch (error) {
                console.error('Search error:', error);
                alert('An error occurred while searching');
            }
        }

        // Camera functions
        async function startCamera() {
            const selectedType = document.getElementById('captureImageType').value;
            if (!selectedType) {
                showNotification('‚ö†Ô∏è Please select an image type first', 'warning');
                return;
            }
            
            try {
                const video = document.getElementById('camera');
                
                // Check if camera permissions are available
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('Camera API not supported in this browser');
                }
                
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        facingMode: 'environment' // Use back camera if available
                    } 
                });
                
                video.srcObject = stream;
                await video.play();
                
                document.getElementById('canvas').style.display = 'block';
                document.getElementById('captureButtons').style.display = 'none'; // Hide until capture
                document.getElementById('capturedImagePreview').innerHTML = ''; // Clear previous preview
                document.getElementById('captureBtn').disabled = false; // Enable capture button
                document.getElementById('stopCameraBtn').disabled = false; // Enable stop button
                document.getElementById('startCameraBtn').disabled = true; // Disable start button
                document.getElementById('cameraStatus').style.display = 'block'; // Show camera status
                
                showNotification('üì∏ Camera started successfully!', 'success');
                console.log('üì∏ Camera started successfully');
                
            } catch (error) {
                console.error('Error starting camera:', error);
                
                let errorMessage = 'Could not start camera. ';
                if (error.name === 'NotAllowedError') {
                    errorMessage += 'Please allow camera access when prompted.';
                } else if (error.name === 'NotFoundError') {
                    errorMessage += 'No camera found on this device.';
                } else if (error.name === 'NotSupportedError') {
                    errorMessage += 'Camera not supported in this browser.';
                } else {
                    errorMessage += 'Please ensure you have a webcam and permissions.';
                }
                
                showNotification(errorMessage, 'danger');
                document.getElementById('cameraStatus').style.display = 'none'; // Hide camera status on error
            }
        }

        // Camera functions
        async function startCamera() {
            const selectedType = document.getElementById('captureImageType').value;
            if (!selectedType) {
                showNotification('‚ö†Ô∏è Please select an image type first', 'warning');
                return;
            }
            
            try {
                const video = document.getElementById('camera');
                
                // Check if camera permissions are available
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('Camera API not supported in this browser');
                }
                
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        facingMode: 'environment' // Use back camera if available
                    } 
                });
                
                video.srcObject = stream;
                await video.play();
                
                document.getElementById('canvas').style.display = 'block';
                document.getElementById('captureButtons').style.display = 'none'; // Hide until capture
                document.getElementById('capturedImagePreview').innerHTML = ''; // Clear previous preview
                document.getElementById('captureBtn').disabled = false; // Enable capture button
                document.getElementById('stopCameraBtn').disabled = false; // Enable stop button
                document.getElementById('startCameraBtn').disabled = true; // Disable start button
                document.getElementById('cameraStatus').style.display = 'block'; // Show camera status
                
                showNotification('üì∏ Camera started successfully!', 'success');
                console.log('üì∏ Camera started successfully');
                
            } catch (error) {
                console.error('Error starting camera:', error);
                
                let errorMessage = 'Could not start camera. ';
                if (error.name === 'NotAllowedError') {
                    errorMessage += 'Please allow camera access when prompted.';
                } else if (error.name === 'NotFoundError') {
                    errorMessage += 'No camera found on this device.';
                } else if (error.name === 'NotSupportedError') {
                    errorMessage += 'Camera not supported in this browser.';
                } else {
                    errorMessage += 'Please ensure you have a webcam and permissions.';
                }
                
                showNotification(errorMessage, 'danger');
                document.getElementById('cameraStatus').style.display = 'none'; // Hide camera status on error
            }
        }

        function stopCamera() {
            const video = document.getElementById('camera');
            if (stream) {
                const tracks = stream.getTracks();
                tracks.forEach(track => track.stop());
                stream = null;
                video.srcObject = null;
                document.getElementById('canvas').style.display = 'none';
                document.getElementById('captureButtons').style.display = 'none';
                document.getElementById('capturedImagePreview').innerHTML = ''; // Clear preview
                document.getElementById('captureBtn').disabled = true; // Disable capture button
                document.getElementById('stopCameraBtn').disabled = true; // Disable stop button
                document.getElementById('startCameraBtn').disabled = false; // Enable start button
                document.getElementById('cameraStatus').style.display = 'none'; // Hide camera status
                console.log('üì∏ Camera stopped');
            }
        }

        function captureImage() {
            const selectedType = document.getElementById('captureImageType').value;
            if (!selectedType) {
                showNotification('‚ö†Ô∏è Please select an image type first', 'warning');
                return;
            }
            
            const video = document.getElementById('camera');
            const canvas = document.getElementById('canvas');
            const context = canvas.getContext('2d');
            
            // Set canvas dimensions to match video
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // Draw the current video frame to canvas
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Convert to JPEG with good quality
            capturedImage = canvas.toDataURL('image/jpeg', 0.9);
            
            // Show preview
            document.getElementById('capturedImagePreview').innerHTML = `
                <div class="alert alert-success">
                    <h6><i class="fas fa-check-circle me-2"></i>Image Captured!</h6>
                    <img src="${capturedImage}" alt="Captured Image" style="max-width: 100%; max-height: 150px; border-radius: 8px; margin: 10px 0;">
                    <div><strong>Type:</strong> ${selectedType.toUpperCase()} VIEW</div>
                </div>
            `;
            document.getElementById('captureButtons').style.display = 'block';
            
            console.log(`üì∏ Image captured for ${selectedType} view`);
        }

        function useCapturedImage() {
            const selectedType = document.getElementById('captureImageType').value;
            if (selectedType && capturedImage) {
                // Check if this image type already has an image
                if (uploadedImages[selectedType]) {
                    if (!confirm(`This will replace the existing ${selectedType} image. Continue?`)) {
                        return;
                    }
                }
                
                uploadedImages[selectedType] = capturedImage;
                const previewDiv = document.getElementById(`${selectedType}ImagePreview`);
                previewDiv.innerHTML = `
                    <img src="${capturedImage}" class="image-preview" alt="${selectedType.toUpperCase()} VIEW">
                    <div class="image-type-label">${selectedType.toUpperCase()} VIEW (Live Capture)</div>
                `;
                document.getElementById(`${selectedType}ImageArea`).classList.add('has-image');
                
                // Reset camera interface
                document.getElementById('captureImagePreview').innerHTML = '';
                document.getElementById('captureButtons').style.display = 'none';
                document.getElementById('captureImageType').value = '';
                
                // Check if ready to upload
                checkUploadReady();
                
                // Show success message
                showNotification(`‚úÖ ${selectedType.toUpperCase()} image captured and assigned successfully!`, 'success');
                
                console.log(`‚úÖ Captured image assigned to ${selectedType} view`);
            }
        }

        function discardCapturedImage() {
            document.getElementById('capturedImagePreview').innerHTML = '';
            document.getElementById('captureButtons').style.display = 'none';
            capturedImage = null;
            console.log('üóëÔ∏è Captured image discarded');
        }

        // Show notification function
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            // Add to page
            document.body.appendChild(notification);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }

        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('userData');
            window.location.href = '/';
        }

        // Check if browser supports camera API
        function checkCameraSupport() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                document.getElementById('captureImageType').disabled = true;
                document.getElementById('startCameraBtn').disabled = true;
                document.getElementById('captureInstructions').innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Camera not supported:</strong> Your browser doesn't support camera access.
                        <br><small>Please use a modern browser like Chrome, Firefox, or Safari.</small>
                    </div>
                `;
                return false;
            }
            return true;
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            
            // Check camera support
            checkCameraSupport();
            
            // Load cars after authentication check
            setTimeout(() => {
                if (localStorage.getItem('authToken')) {
                    loadCars();
                }
            }, 1000);
        });
    </script>
</body>
</html>
